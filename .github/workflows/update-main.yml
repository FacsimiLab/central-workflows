name: Release

on:
  workflow_call:
    inputs:
      action-runs-on:
        description: 'The type of runner to run the job on'
        required: false
        default: 'ubuntu-latest'
        type: string
      ref:
        description: 'Git ref to checkout (branch or SHA)'
        required: false
        type: string
        default: 'release'
      git_config_user:
        required: false
        type: string
        description: 'User name to use for git commits'
        default: 'FacsimiLab Bot'
      git_config_email:
        required: false
        type: string
        default: '195262995+facsimilab-bot@users.noreply.github.com'
    secrets:
      SSH_PRIVATE_KEY:
        required: false
      SSH_PUBLIC_KEY:
        required: false

permissions:
  id-token: write
  contents: write

concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true


jobs:

  update-main:
    runs-on: ${{ inputs.action-runs-on }}
    permissions:
      contents: write
    env: 
      LOG_FILE: ${{ github.workspace }}/.github/log/ci.log
    steps:
      - name: Checkout Repository at workflow SHA
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Force correct release branch on workflow SHA
        run: git checkout -B ${{ inputs.ref }}

      - name: Checkout central workflows
        uses: actions/checkout@v6.0.2
        with:
          repository: FacsimiLab/central-workflows
          path: .central-workflows

      - name: Detect SSH key
        id: ssh_key_present
        uses: ./.github/actions/secret-present
        with:
          value: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      - name: Set up SSH agent
        if: ${{ steps.ssh_key_present.outputs.present == 'true' }}
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup Git Config
        run: |
          git config --global user.name "${{ inputs.git_config_user }}"
          git config --global user.email "${{ inputs.git_config_email }}"

          git config include.path "${{ github.workspace }}/.central-workflows/scripts/git/addon-git-config.toml"


      - name: Convert HTTPS remote to SSH
        if: ${{ steps.ssh_key_present.outputs.present == 'true' }}
        run: |
          HTTPS_URL=$(git remote get-url origin)
          if [[ "$HTTPS_URL" == https://github.com/* ]]; then
            SSH_URL=$(echo "$HTTPS_URL" | sed -E 's#https://github.com/#git@github.com:#')
            git remote set-url origin "$SSH_URL"
          fi
          git remote -v

      - name: Add github host keys
        if: ${{ steps.ssh_key_present.outputs.present == 'true' }}
        run: |
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Get the latest CHANGELOG from the `log` branch or initialize it
        env:
          LOG_FILE: ${{ github.workspace }}/.github/log/ci.log
        run: |
          bash ./.central-workflows/scripts/git/log-worktree.sh

      - name: Update main branch
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)

          # Ensure main is up to date
          git fetch origin main:main

          git checkout main || git checkout -b main origin/main

          if git merge release -v -m "ci: merge release into main"; then
            git push origin main
            echo "Successfully merged 'release' into 'main' and pushed." >> $GITHUB_STEP_SUMMARY
          else
            echo "Merge failed â€” possible conflicts. Manual resolution required." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi